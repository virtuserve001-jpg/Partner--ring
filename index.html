<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“± Partner Ringer Pro+</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff006e">
<meta name="description" content="Real-time partner ringing app">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#0f0f23;color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center}
.container{width:100%;max-width:420px;background:#1a1a35;border-radius:20px;padding:20px}
button,input{width:100%;padding:15px;border-radius:12px;border:none;margin-bottom:10px}
button{background:#ff006e;color:#fff;font-weight:bold}
button:active{transform:scale(.97)}
.incoming{display:none;border:2px solid #ff006e;padding:20px;border-radius:12px;text-align:center}
.incoming.active{display:block}
</style>
</head>

<body>
<div class="container">
  <h2>ğŸ“± Partner Ringer Pro+</h2>

  <input id="myId" readonly>
  <button onclick="copyMyId()">ğŸ“‹ Copy My ID</button>

  <input id="partnerId" placeholder="Partner ID">
  <button onclick="sendCall()">ğŸ“ RING PARTNER</button>

  <div class="incoming" id="incoming">
    <h3>ğŸ“³ Incoming Call</h3>
    <p id="caller"></p>
    <button onclick="stopCall()">Dismiss</button>
  </div>
</div>

<audio id="ringtone" preload="auto" loop playsinline>
  <source src="soft-alarm1.mp3" type="audio/mpeg">
</audio>

<script>
// ğŸ”¥ Firebase
firebase.initializeApp({
  apiKey: "AIzaSyBdvlOGpTCBRgfKgZlFOCjSEZ_ZeNm_W5k",
  authDomain: "partner-ring.firebaseapp.com",
  databaseURL: "https://partner-ring-default-rtdb.firebaseio.com",
  projectId: "partner-ring"
});
const db = firebase.database();

// ğŸ†” Device ID
let myId = localStorage.getItem("PR_ID");
if(!myId){
  myId = "PR-" + crypto.randomUUID().slice(0,8).toUpperCase();
  localStorage.setItem("PR_ID", myId);
}
document.getElementById("myId").value = myId;

// ğŸ”Š Audio unlock (CRITICAL FIX)
const ringtone = document.getElementById("ringtone");
let unlocked = false;
function unlock(){
  ringtone.play().then(()=>{
    ringtone.pause();
    ringtone.currentTime = 0;
    unlocked = true;
  }).catch(()=>{});
  document.removeEventListener("click", unlock);
  document.removeEventListener("touchstart", unlock);
}
document.addEventListener("click", unlock, {once:true});
document.addEventListener("touchstart", unlock, {once:true});

// ğŸ“ Send Call
function sendCall(){
  const pid = document.getElementById("partnerId").value.trim();
  if(!pid) return alert("Enter partner ID");
  localStorage.setItem("PARTNER_ID", pid);

  db.ref("calls/"+pid).set({
    from: myId,
    time: Date.now()
  });
}

// ğŸ“³ Receive Call
db.ref("calls/"+myId).on("value", snap=>{
  if(!snap.exists()) return;
  const data = snap.val();
  document.getElementById("incoming").classList.add("active");
  document.getElementById("caller").innerText = "From: " + data.from;
  playRingtone();
});

// ğŸ”” Play ringtone (FIXED replay)
function playRingtone(){
  if(!unlocked) return;
  ringtone.currentTime = 0;
  ringtone.play().catch(()=>{});
  if("vibrate" in navigator) navigator.vibrate([300,150,300]);
}

// âŒ Stop call
function stopCall(){
  ringtone.pause();
  ringtone.currentTime = 0;
  db.ref("calls/"+myId).remove();
  document.getElementById("incoming").classList.remove("active");
}

// ğŸ“‹ Copy ID
function copyMyId(){
  navigator.clipboard.writeText(myId);
  alert("Copied!");
}

// ğŸ§© Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>