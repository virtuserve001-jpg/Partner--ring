<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“± Partner Ringer Pro+</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff006e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Partner Ringer">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ---- STYLES UNCHANGED (SAFE) ---- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:linear-gradient(135deg,#0f0f23,#1a1a35);color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px}
.container{width:100%;max-width:420px;background:#1a1a35;border-radius:20px;overflow:hidden}
.header{background:linear-gradient(135deg,#ff006e,#8338ec);padding:25px;text-align:center;position:relative}
.status{position:absolute;top:10px;right:10px;width:12px;height:12px;border-radius:50%;background:#06ffa5}
.status.offline{background:#ff006e}
.content{padding:20px}
input,button{width:100%;padding:14px;margin-bottom:12px;border-radius:12px;border:none}
input{background:#0f0f23;color:#fff;border:2px solid #8338ec}
button{background:#ff006e;color:#fff;font-weight:bold}
button:disabled{opacity:.6}
.incoming{display:none;border:2px solid #ff006e;padding:20px;border-radius:12px;text-align:center}
.incoming.active{display:block}
.tabs{display:flex;margin-bottom:15px}
.tab{flex:1;background:none;color:#fff;opacity:.6;border:none}
.tab.active{opacity:1;border-bottom:3px solid #ff006e}
.tab-content{display:none}
.tab-content.active{display:block}
.small{font-size:.85em;opacity:.7;margin-bottom:6px}
.toggle{width:50px;height:26px;background:#8338ec;border-radius:13px;position:relative;cursor:pointer}
.toggle.active{background:#06ffa5}
.toggle-slider{width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:.2s}
.toggle.active .toggle-slider{transform:translateX(24px)}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="status offline" id="connectionStatus"></div>
    <h1>ğŸ“± Partner Ringer Pro+</h1>
    <p>Real-time internet ringing</p>
  </div>

  <div class="content">

    <div class="tabs">
      <button class="tab active" onclick="switchTab(0)">ğŸ“</button>
      <button class="tab" onclick="switchTab(1)">ğŸ”—</button>
      <button class="tab" onclick="switchTab(2)">âš™ï¸</button>
    </div>

    <!-- CALL TAB -->
    <div class="tab-content active" id="tab0">
      <div class="small">Your Device ID</div>
      <input id="myId" readonly>
      <button onclick="copyMyId()">ğŸ“‹ Copy My ID</button>

      <div class="small">Partner ID</div>
      <input id="partnerId">
      <button id="callBtn">ğŸ“ RING PARTNER</button>

      <div class="incoming" id="incomingBox">
        <h3>ğŸ“³ Incoming Call</h3>
        <p id="callerInfo"></p>
        <button onclick="dismissCall()">Dismiss</button>
      </div>
    </div>

    <!-- PAIR TAB -->
    <div class="tab-content" id="tab1">
      <button onclick="generatePairCode()">Generate Pair Code</button>
      <h2 id="pairCode"></h2>
      <input id="pairCodeInput" placeholder="Enter code">
      <button onclick="joinWithCode()">Connect</button>
    </div>

    <!-- SETTINGS -->
    <div class="tab-content" id="tab2">
      <div class="small">Sound</div>
      <div class="toggle active" id="soundToggle" onclick="toggleSound()">
        <div class="toggle-slider"></div>
      </div>
    </div>

  </div>
</div>

<audio id="ringtone" loop preload="auto">
  <source src="soft-alarm1.mp3" type="audio/mpeg">
</audio>

<script>
/* -------- FIREBASE -------- */
firebase.initializeApp({
  apiKey:"AIzaSyBdvlOGpTCBRgfKgZlFOCjSEZ_ZeNm_W5k",
  databaseURL:"https://partner-ring-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* -------- SAFE STATE -------- */
let settings = JSON.parse(localStorage.getItem('SETTINGS')||'{"sound":true}');
let myId = localStorage.getItem('MY_ID');
if(!myId){
  myId = 'PR-' + Math.random().toString(36).substr(2,8).toUpperCase();
  localStorage.setItem('MY_ID', myId);
}
document.getElementById('myId').value = myId;

/* -------- CONNECTION -------- */
db.ref('.info/connected').on('value', s=>{
  document.getElementById('connectionStatus')
    .classList.toggle('offline', !s.val());
});

/* -------- AUDIO -------- */
const ringtone = document.getElementById('ringtone');
let interacted=false;
['click','touchstart'].forEach(e=>{
  document.addEventListener(e,()=>interacted=true,{once:true});
});

function playSound(){
  if(settings.sound && interacted){
    ringtone.play().catch(()=>{});
  }
}
function stopSound(){
  ringtone.pause();
  ringtone.currentTime=0;
}

/* -------- CALL LOGIC -------- */
document.getElementById('callBtn').onclick=()=>{
  const partner = partnerId.value.trim();
  if(!partner || partner===myId) return alert('Invalid partner ID');
  db.ref('calls/'+partner).push({from:myId,time:Date.now()});
};

db.ref('calls/'+myId).on('child_added', snap=>{
  const data = snap.val();
  snap.ref.remove();
  document.getElementById
